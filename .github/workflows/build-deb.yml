name: Build DEB Package

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-deb:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-dev python3-gi python3-gi-cairo gir1.2-gtk-3.0
        
    - name: Prepare DEB package structure
      run: |
        cd sdcard-formatter-deb
        DEB_DIR="sdcard-formatter_1.0.0"
        
        # Copy GUI script
        cp ../sdcard-formatter-installer/bin/sd_formatter_gui.py "$DEB_DIR/usr/local/bin/"
        chmod +x "$DEB_DIR/usr/local/bin/sd_formatter_gui.py"
        
        # Copy desktop file
        cp ../sdcard-formatter-installer/sdcard-formatter.desktop "$DEB_DIR/usr/share/applications/"
        
        # Copy icon if exists
        if [ -f ../sdcard-formatter-installer/icons/sdcard-formatter.png ]; then
          cp ../sdcard-formatter-installer/icons/sdcard-formatter.png "$DEB_DIR/usr/share/icons/hicolor/256x256/apps/"
        fi
        
        # Set permissions
        chmod 755 "$DEB_DIR/DEBIAN"
        chmod 644 "$DEB_DIR/DEBIAN/control"
        
    - name: Build DEB package
      run: |
        cd sdcard-formatter-deb
        dpkg-deb --build --root-owner-group sdcard-formatter_1.0.0
        
    - name: Upload DEB artifact
      uses: actions/upload-artifact@v4
      with:
        name: sdcard-formatter-deb
        path: sdcard-formatter-deb/sdcard-formatter_1.0.0.deb
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: sdcard-formatter-deb/sdcard-formatter_1.0.0.deb
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
